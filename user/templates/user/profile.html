{% extends "base.html" %}
{% load static %}

{% block content %}
<link rel="stylesheet" href="{% static 'css/profile.css' %}">

<div class="profile-page">
  <!-- Left column: profile info and form -->
  <div class="profile-content">
    <!-- Profile Header -->
    <div class="profile-header">
      <div class="avatar-section">
        {% if user.avatar %}
          <img src="{{ user.avatar.url }}" alt="Avatar" class="avatar" id="avatarPreview">
        {% else %}
          <img src="{% static 'images/default-avatar.png' %}" alt="Avatar" class="avatar" id="avatarPreview">
        {% endif %}

        <!-- Hidden file input -->
        <input type="file" name="avatar" id="avatarInput" accept="image/*" style="display: none;">
        <!-- Avatar action buttons -->
        <div class="avatar-buttons">
          <button type="button" class="edit-btn" onclick="document.getElementById('avatarInput').click();">Change Picture</button>
          <button type="button" class="edit-btn clear-btn" onclick="clearAvatar()">Clear</button>
        </div>
      </div>

      <div class="user-info">
        <h2>{{ user.full_name }}</h2>
        <p>{{ user.email }}</p>
      </div>
    </div>

    <!-- Profile Form -->
    <form method="POST" enctype="multipart/form-data" class="profile-form" id="profileForm">
      {% csrf_token %}
      {% for field in form %}
        {% if field.name != "avatar" %}
          <div class="form-group" style="display: flex; align-items: center;">
            <label for="{{ field.id_for_label }}" style="flex: 1;">{{ field.label }}</label>
            {{ field }}
            <button type="button" class="edit-btn" data-field-id="{{ field.auto_id }}" style="margin-left: 10px;">
              Edit
            </button>
            {{ field.errors }}
          </div>
        {% endif %}
      {% endfor %}
      <button type="submit" class="btn-submit" style="display:none;" id="saveBtn">Save Changes</button>
    </form>

    <!-- Bottom Actions -->
    <div class="bottom-actions">
      <a href="{% url 'update-password' %}" class="password-link">Update Password</a>
    </div>
  </div>

  <!-- Right column: request post banner -->
  <div class="request-post-section">
    <div class="request-post-banner">
      <div class="banner-overlay">
        <h2 class="banner-title">Request a Post</h2>
        <a href="#" class="btn-request-post">Request a Post</a>
      </div>
    </div>
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    const editButtons = document.querySelectorAll('.edit-btn[data-field-id]');
    const saveBtn = document.getElementById('saveBtn');

    editButtons.forEach(button => {
      button.addEventListener('click', () => {
        const fieldId = button.getAttribute('data-field-id');
        const inputField = document.getElementById(fieldId);

        if (inputField) {
          inputField.disabled = false;
          inputField.focus();
          saveBtn.style.display = 'block';
          button.style.display = 'none';
        }
      });
    });

    // Show Save button when a new avatar is selected
    const avatarInput = document.getElementById('avatarInput');
    avatarInput.addEventListener('change', () => {
      if (avatarInput.files.length > 0) {
        saveBtn.style.display = 'block';

        // Preview selected image
        const reader = new FileReader();
        reader.onload = e => {
          document.getElementById('avatarPreview').src = e.target.result;
        };
        reader.readAsDataURL(avatarInput.files[0]);
      }
    });
  });

  function clearAvatar() {
    const avatarInput = document.getElementById('avatarInput');
    avatarInput.value = "";
    document.getElementById('avatarPreview').src = "{% static 'images/default-avatar.png' %}";
    document.getElementById('saveBtn').style.display = 'block';
  }
</script>
{% endblock %}
